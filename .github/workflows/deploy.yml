name: üöÄ Despliegue autom√°tico a Hostinger

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Descargar el repositorio
        uses: actions/checkout@v3

      - name: üì¶ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: üßπ Limpiar dist y cach√©
        run: rm -rf dist node_modules/.tmp
        working-directory: frontend

      - name: üîß Instalar dependencias
        run: pnpm install --no-frozen-lockfile
        working-directory: frontend

      - name: üèóÔ∏è Construir la aplicaci√≥n
        run: pnpm build
        working-directory: frontend

      - name: üìÇ Verificar build
        run: ls -la frontend/dist

      - name: üîê Probar login FTP (diagn√≥stico)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp
          echo "== Modo 1: FTP plano ==";
          set +e
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" -e "set ftp:ssl-allow no; set net:max-retries 1; pwd; ls; bye" "$FTP_SERVER" || echo "(Fallo FTP plano)"
          echo "== Modo 2: FTPS expl√≠cito ignorando cert ==";
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" -e "set ftp:ssl-force yes; set ftp:ssl-protect-data yes; set ssl:verify-certificate no; set net:max-retries 1; pwd; ls; bye" "$FTP_SERVER" || echo "(Fallo FTPS expl√≠cito)"
          echo "Revisa arriba: si ambos muestran 530 => credenciales. Si s√≥lo FTPS da CN mismatch puedes seguir con FTP plano o ajustar host al CN del cert.";
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}

      - name: Subir a Hostinger por FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }} # Debe coincidir exactamente (ej: reformix)
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp # S√≥lo cambiar a ftps si activas TLS expl√≠cito
          local-dir: frontend/dist/ # Contenido compilado
          server-dir: public_html/ # Ra√≠z de tu dominio para este usuario
          exclude: |
            **/.git*
            **/node_modules/**
            **/*.map
            **/story*/**
          log-level: verbose
          dangerous-clean-slate: true # Borra archivos remotos que no existan local (confirma antes)
